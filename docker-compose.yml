services:

  # ----------------------
  # Servidor de referÃªncia
  # ----------------------
  ref:
    build: ./ref
    container_name: ref
    environment:
      - REF_PORT=5550
    ports:
      - "5550:5550"
    networks:
      - chatnet

  # ----------------------
  # Broker REQ/DEALER
  # ----------------------
  broker:
    build: ./broker
    container_name: broker
    environment:
      - FRONTEND_ROUTER_ADDR=tcp://*:5555
      - BACKEND_DEALER_ADDR=tcp://*:6000
    ports:
      - "5555:5555"
      - "6000:6000"
    networks:
      - chatnet

  # ----------------------
  # Proxy PUB/SUB
  # ----------------------
  proxy:
    build: ./proxy
    container_name: proxy
    environment:
      - XSUB_ADDR=tcp://*:5557
      - XPUB_ADDR=tcp://*:5558
    ports:
      - "5557:5557"
      - "5558:5558"
    networks:
      - chatnet

  # ----------------------
  # Servidor A
  # ----------------------
  server_a:
    build: ./server
    container_name: server_a
    environment:
      - SERVER_NAME=ServidorA
      - SERVER_ADDR=tcp://server_a:7000
      - BROKER_DEALER_ADDR=tcp://broker:6000
      - REF_ADDR=tcp://ref:5550
      - PROXY_PUB_ADDR=tcp://proxy:5557
      - PROXY_SUB_ADDR=tcp://proxy:5558
    volumes:
      - ./data/server_a:/app/data
    ports:
      - "7000:7000"
    depends_on:
      - broker
      - proxy
      - ref
    networks:
      - chatnet

  # ----------------------
  # Servidor B
  # ----------------------
  server_b:
    build: ./server
    container_name: server_b
    environment:
      - SERVER_NAME=ServidorB
      - SERVER_ADDR=tcp://server_b:7001
      - BROKER_DEALER_ADDR=tcp://broker:6000
      - REF_ADDR=tcp://ref:5550
      - PROXY_PUB_ADDR=tcp://proxy:5557
      - PROXY_SUB_ADDR=tcp://proxy:5558
    volumes:
      - ./data/server_b:/app/data
    ports:
      - "7001:7001"
    depends_on:
      - broker
      - proxy
      - ref
    networks:
      - chatnet

  # ----------------------
  # Servidor C
  # ----------------------
  server_c:
    build: ./server
    container_name: server_c
    environment:
      - SERVER_NAME=ServidorC
      - SERVER_ADDR=tcp://server_c:7002
      - BROKER_DEALER_ADDR=tcp://broker:6000
      - REF_ADDR=tcp://ref:5550
      - PROXY_PUB_ADDR=tcp://proxy:5557
      - PROXY_SUB_ADDR=tcp://proxy:5558
    volumes:
      - ./data/server_c:/app/data
    ports:
      - "7002:7002"
    depends_on:
      - broker
      - proxy
      - ref
    networks:
      - chatnet

  # ----------------------
  # Bots
  # ----------------------
  bot_1:
    build: ./bot
    container_name: bot_1
    environment:
      - BROKER_ADDR=tcp://broker:5555
      - PROXY_SUB_ADDR=tcp://proxy:5558
    networks:
      - chatnet

  bot_2:
    build: ./bot
    container_name: bot_2
    environment:
      - BROKER_ADDR=tcp://broker:5555
      - PROXY_SUB_ADDR=tcp://proxy:5558
    networks:
      - chatnet

  # ----------------------
  # Cliente
  # ----------------------
  client:
    build: ./client
    container_name: client
    environment:
      - REQ_ADDR=tcp://broker:5555
      - PROXY_SUB_ADDR=tcp://proxy:5558
    networks:
      - chatnet
    stdin_open: true
    tty: true

# ----------------------
# Rede interna
# ----------------------
networks:
  chatnet:
    driver: bridge
